<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>GATEGO - Digital Pelabuhan</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --bg: #f8fafa;
        --panel: #fff;
        --muted: #6b7280;
        --text: #1f2937;
        --accent: #10b981;
        --ok: #10b981;
        --warn: #f59e0b;
        --err: #ef4444;
        --line: #e5e7eb;
        --primary-green: #10b981;
        --light-green: #d1fae5;
        --dark-green: #059669;
        --gradient-bg: linear-gradient(
          135deg,
          var(--primary-green) 0%,
          var(--dark-green) 100%
        );
      }
      * {
        box-sizing: border-box;
      }
      html,
      body {
        min-height: 100%;
      }
      body {
        margin: 0;
        font: 16px/1.6 "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI",
          Arial, sans-serif;
        color: var(--text);
        background: var(--bg);
      }
      a {
        color: inherit;
        text-decoration: none;
      }
      .wrap {
        max-width: 1400px;
        margin: 0 auto;
        padding: 24px;
      }
      .topbar {
        display: flex;
        gap: 16px;
        align-items: center;
        justify-content: space-between;
        padding: 20px 24px;
        border: 1px solid var(--line);
        border-radius: 16px;
        background: var(--panel);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        margin-bottom: 24px;
      }
      .brand {
        display: flex;
        gap: 12px;
        align-items: center;
        font-weight: 700;
        font-size: 20px;
      }
      .brand .logo {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        background: var(--gradient-bg);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 900;
        font-size: 20px;
        box-shadow: 0 2px 4px rgba(16, 185, 129, 0.2);
      }
      .content {
        margin-top: 0;
      }
      .grid {
        display: grid;
        gap: 20px;
      }
      .g-2 {
        grid-template-columns: repeat(2, 1fr);
      }
      .g-3 {
        grid-template-columns: repeat(3, 1fr);
      }
      .g-4 {
        grid-template-columns: repeat(4, 1fr);
      }
      @media (max-width: 1200px) {
        .g-4 {
          grid-template-columns: repeat(2, 1fr);
        }
      }
      @media (max-width: 900px) {
        .g-2,
        .g-3,
        .g-4 {
          grid-template-columns: 1fr;
        }
      }
      .card {
        background: var(--panel);
        border: 1px solid var(--line);
        border-radius: 16px;
        padding: 24px;
        margin-bottom: 20px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s, box-shadow 0.2s;
      }
      .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px -3px rgba(0, 0, 0, 0.1);
      }
      .card h3 {
        margin: 0 0 16px 0;
        font-size: 20px;
        color: var(--text);
        font-weight: 600;
      }
      .hero-card {
        background: var(--gradient-bg);
        color: white;
        text-align: center;
        padding: 48px 24px;
      }
      .hero-card h1 {
        font-size: 2.5rem;
        font-weight: 700;
        margin: 0 0 16px 0;
      }
      .hero-card p {
        font-size: 1.125rem;
        opacity: 0.9;
        margin: 0 0 32px 0;
        max-width: 500px;
        margin-left: auto;
        margin-right: auto;
      }
      .muted {
        color: var(--muted);
      }
      .badge {
        font-size: 12px;
        padding: 8px 12px;
        border-radius: 8px;
        font-weight: 600;
        display: inline-block;
      }
      .badge.ok {
        background: var(--light-green);
        color: var(--dark-green);
      }
      .badge.warn {
        background: #fef3c7;
        color: #d97706;
      }
      .badge.err {
        background: #fee2e2;
        color: #dc2626;
      }
      .badge.info {
        background: #dbeafe;
        color: #2563eb;
      }
      .toolbar {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        align-items: center;
        padding-top: 16px;
      }
      .btn {
        padding: 14px 20px;
        border-radius: 10px;
        background: var(--primary-green);
        color: #fff;
        border: 0;
        cursor: pointer;
        font-weight: 600;
        font-size: 14px;
        transition: all 0.2s;
        box-shadow: 0 2px 4px rgba(16, 185, 129, 0.2);
      }
      .btn:hover {
        background: var(--dark-green);
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(16, 185, 129, 0.3);
      }
      .btn.ghost {
        background: white;
        border: 1px solid var(--line);
        color: var(--text);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .btn.ghost:hover {
        background: #f9fafb;
        border-color: var(--primary-green);
        color: var(--primary-green);
      }
      .btn.warn {
        background: var(--warn);
        box-shadow: 0 2px 4px rgba(245, 158, 11, 0.2);
      }
      .btn.warn:hover {
        background: #d97706;
      }
      .btn.err {
        background: var(--err);
        box-shadow: 0 2px 4px rgba(239, 68, 68, 0.2);
      }
      .btn.err:hover {
        background: #dc2626;
      }
      .btn.ok {
        background: var(--ok);
        box-shadow: 0 2px 4px rgba(16, 185, 129, 0.2);
      }
      .btn.ok:hover {
        background: var(--dark-green);
      }
      .btn.small {
        padding: 10px 16px;
        font-size: 13px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
        background: #fff;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }
      th,
      td {
        padding: 16px;
        border-bottom: 1px solid var(--line);
        vertical-align: top;
        text-align: left;
      }
      th {
        background: #f9fafb;
        font-weight: 600;
        color: var(--text);
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      tr:hover td {
        background: #f9fafb;
      }
      .table-wrap {
        overflow-x: auto;
        border-radius: 12px;
      }
      @media (max-width: 700px) {
        th,
        td {
          padding: 12px 8px;
        }
        .card {
          padding: 16px;
        }
        .btn {
          padding: 12px 16px;
        }
        .wrap {
          padding: 16px;
        }
      }
      .hide {
        display: none !important;
      }
      /* Kamera styling */
      .inline-camera-view {
        width: 100%;
        min-height: 200px;
        border-radius: 12px;
        border: 1px solid var(--line);
        background: #f9fafb;
        margin-bottom: 12px;
        object-fit: cover;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .camera-status {
        font-size: 13px;
        color: var(--muted);
        margin-top: 8px;
        font-weight: 500;
      }
      /* Modal */
      #barcode-modal {
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1),
          0 10px 10px -5px rgba(0, 0, 0, 0.04);
        border-radius: 16px;
      }
      @media (max-width: 500px) {
        #barcode-modal {
          max-width: 95vw;
        }
        .wrap {
          padding: 16px;
        }
      }
      .detail-cell {
        max-height: 80px;
        overflow: hidden;
        position: relative;
        transition: max-height 0.3s ease;
      }
      .detail-cell.open {
        max-height: 600px;
        overflow: auto;
        background: #f9fafb;
        padding: 12px;
        border-radius: 8px;
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
      }
      .detail-toggle {
        display: inline-block;
        margin-top: 8px;
        color: var(--primary-green);
        cursor: pointer;
        font-size: 13px;
        font-weight: 600;
        background: none;
        border: none;
        padding: 0;
        transition: color 0.2s;
      }
      .detail-toggle:hover {
        color: var(--dark-green);
      }
      /* Login page */
      #login-page {
        max-width: 500px;
        margin: 80px auto 0 auto;
        padding: 0 24px;
      }
      #login-page .card {
        padding: 48px;
        text-align: center;
        border-radius: 20px;
        box-shadow: 0 10px 25px -3px rgba(0, 0, 0, 0.1);
      }
      #login-page h2 {
        margin-bottom: 32px;
        font-size: 28px;
        font-weight: 700;
      }
      #login-page .btn {
        width: 100%;
        margin-bottom: 16px;
        padding: 16px;
        font-size: 16px;
        border-radius: 12px;
      }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  </head>
  <body>
    <div id="login-page">
      <div class="card">
        <h2>Login GATEGO</h2>
        <button class="btn ok" onclick="loginAs('admin')">
          Login sebagai Admin
        </button>
        <button class="btn warn" onclick="loginAs('operator')">
          Login sebagai Operator
        </button>
      </div>
    </div>

    <div id="admin-page" class="hide">
      <div class="wrap">
        <div class="topbar">
          <span class="brand"><span class="logo">G</span> Admin Pelabuhan</span>
          <div style="display: flex; gap: 12px">
            <button id="btn-reset-admin" class="btn err">Reset Data</button>
            <button id="btn-logout-admin" class="btn ghost">Logout</button>
          </div>
        </div>
        <div class="content grid g-2">
          <div class="card">
            <h3>Kamera Gate OCR</h3>
            <video
              id="admin-camera-feed-1"
              class="inline-camera-view"
              src="test.mp4"
              controls
              loop
              autoplay
              muted
              playsinline
            ></video>
            <div id="admin-camera-status-1" class="camera-status">
              Video Simulasi
            </div>
          </div>
          <div class="card">
            <h3>Kamera Gate Utama</h3>
            <video
              id="admin-camera-feed-2"
              class="inline-camera-view"
              src="gateutama.mp4"
              controls
              loop
              autoplay
              muted
              playsinline
            ></video>
            <div id="admin-camera-status-2" class="camera-status">
              Video Utama
            </div>
          </div>
        </div>
        <div class="content">
          <div class="card">
            <h3>Simulasi Kedatangan Truk & Jalur Pemeriksaan</h3>
            <div class="toolbar">
              <button class="btn ok" onclick="simulateArrival('hijau')">
                Simulasi Jalur Hijau
              </button>
              <button class="btn warn" onclick="simulateArrival('kuning')">
                Simulasi Jalur Kuning
              </button>
              <button class="btn err" onclick="simulateArrival('merah')">
                Simulasi Jalur Merah
              </button>
              <button id="btn-simulate-ocr-invalid" class="btn ghost">
                Simulasi OCR Tidak Valid
              </button>
            </div>
            <div
              id="barcode-modal"
              class="card hide"
              style="
                position: fixed;
                left: 0;
                top: 0;
                right: 0;
                margin: auto;
                max-width: 400px;
                z-index: 99;
                background: #fff;
              "
            >
              <h4>Scan Barcode Surat Jalan</h4>
              <input
                id="barcode-input"
                class="input"
                placeholder="Masukkan kode barcode..."
              />
              <div class="toolbar">
                <button id="btn-barcode-validate" class="btn ok">
                  Validasi
                </button>
                <button id="btn-barcode-cancel" class="btn err">Batal</button>
              </div>
            </div>
          </div>
          <div class="card" id="jalur-hijau"></div>
          <div class="card" id="jalur-kuning"></div>
          <div class="card" id="jalur-merah"></div>
          <div class="card" id="jalur-ocr"></div>
        </div>
      </div>
    </div>

    <div id="operator-page" class="hide">
      <div class="wrap">
        <div class="topbar">
          <span class="brand"
            ><span class="logo">G</span> Operator Lapangan</span
          >
          <div style="display: flex; gap: 8px">
            <button id="btn-reset-operator" class="btn err">Reset Data</button>
            <button id="btn-logout-operator" class="btn ghost">Logout</button>
          </div>
        </div>
        <div class="content">
          <div class="card">
            <h3>Daftar Kontainer untuk Pemeriksaan</h3>
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th>No. Kontainer</th>
                    <th>No. Polisi Truk</th>
                    <th>Jalur</th>
                    <th>Posisi</th>
                    <th>Klasifikasi</th>
                    <th>Aksi</th>
                    <th>Catatan Admin</th>
                    <th>Hasil Operator</th>
                  </tr>
                </thead>
                <tbody id="operator-table-body"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Helper selector
      function $(sel) {
        return document.querySelector(sel);
      }

      // Dummy database kontainer valid
      const DB_CONTAINERS = [
        { number: "MSCU 123456 7", truck: "B 1234 XYZ" },
        { number: "TGHU 987654 3", truck: "D 5678 ABC" },
      ];

      // Klasifikasi jalur
      function getKlasifikasiJalur(jalur, number) {
        if (jalur === "Jalur Hijau")
          return "Data lengkap & kontainer aman (bukan barang umum)";
        if (jalur === "Jalur Kuning")
          return "Data belum lengkap, kontainer aman";
        if (jalur === "Jalur Merah")
          return "Dokumen belum lengkap & kontainer tidak aman/atau belum terdata di pelindo";
        return "-";
      }

      const KEYS = { items: "gatego_v4_items" };
      const getItems = () =>
        JSON.parse(localStorage.getItem(KEYS.items) || "[]");
      const setItems = (v) =>
        localStorage.setItem(KEYS.items, JSON.stringify(v));

      // Login logic
      function loginAs(role) {
        $("#login-page").classList.add("hide");
        if (role === "admin") {
          $("#admin-page").classList.remove("hide");
          startAdminCameras();
          renderAllTables();
        } else {
          $("#operator-page").classList.remove("hide");
          renderOperatorTable();
        }
        localStorage.setItem("gatego_role", role);
      }

      window.onload = function () {
        const role = localStorage.getItem("gatego_role");
        if (role === "admin") {
          $("#login-page").classList.add("hide");
          $("#admin-page").classList.remove("hide");
          startAdminCameras();
          renderAllTables();
        } else if (role === "operator") {
          $("#login-page").classList.add("hide");
          $("#operator-page").classList.remove("hide");
          renderOperatorTable();
        }
      };

      // Logout logic
      $("#btn-logout-admin").addEventListener("click", () => {
        localStorage.removeItem("gatego_role");
        location.reload();
      });
      $("#btn-logout-operator").addEventListener("click", () => {
        localStorage.removeItem("gatego_role");
        location.reload();
      });

      // Kamera Gate OCR (webcam browser)
      function startAdminCameras() {
        $("#admin-camera-status-1").textContent = "Video Simulasi";
      }

      // Simulasi Jalur Pemeriksaan & Posisi Kontainer
      window.simulateArrival = function (jalur) {
        // Klasifikasi otomatis
        let klasifikasi = "";
        let customsStatus = "";
        let posisi = "";
        let sppb = false;
        let kontainerAman = "";
        if (jalur === "hijau") {
          customsStatus = "Jalur Hijau";
          klasifikasi = "Data lengkap & kontainer aman (bukan barang umum)";
          posisi = "Pre-Staging";
          sppb = true;
          kontainerAman = "Aman";
        } else if (jalur === "kuning") {
          customsStatus = "Jalur Kuning";
          klasifikasi = "Data belum lengkap, kontainer aman";
          posisi = "Gate";
          sppb = true;
          kontainerAman = "Aman";
        } else if (jalur === "merah") {
          customsStatus = "Jalur Merah";
          klasifikasi =
            "Dokumen belum lengkap & kontainer tidak aman/atau belum terdata di pelindo";
          posisi = "Yard";
          sppb = false;
          kontainerAman = "Tidak Aman";
        }
        const db =
          DB_CONTAINERS[Math.floor(Math.random() * DB_CONTAINERS.length)];
        let logArr = [
          { time: new Date().toISOString(), message: `PIB Submitted` },
          { time: new Date().toISOString(), message: `Payment Processed` },
        ];
        if (customsStatus === "Jalur Hijau") {
          logArr.push({
            time: new Date().toISOString(),
            message: `Customs Response: Jalur Hijau`,
          });
          logArr.push({
            time: new Date().toISOString(),
            message: "SPPB Issued",
          });
        } else if (customsStatus === "Jalur Kuning") {
          logArr.push({
            time: new Date().toISOString(),
            message: `Customs Response: Jalur Kuning`,
          });
          logArr.push({
            time: new Date().toISOString(),
            message: "SPPB Issued",
          });
        } else if (customsStatus === "Jalur Merah") {
          logArr.push({
            time: new Date().toISOString(),
            message: `Customs Response: Jalur Merah`,
          });
          logArr.push({
            time: new Date().toISOString(),
            message: "SPPB Belum Terbit",
          });
        }
        const pajak = hitungPajakImpor({
          fob_usd: 5000,
          freight_usd: 500,
          insurance_usd: 50,
          tarif_bea_masuk: 0.05,
          kurs_pajak: 16000,
          biaya_clearance: 150,
          biaya_trucking: 100,
          biaya_storage: 75,
          punya_npwp: true,
        });
        const item = {
          id: "ID" + Math.random().toString(36).slice(2, 9),
          number: db.number,
          truck: db.truck,
          jalur: customsStatus,
          posisi: posisi,
          klasifikasi: klasifikasi,
          status: sppb ? "ocr_valid" : "pending_sppb",
          pajak: pajak,
          log: logArr,
          sentToOperator: false,
          operatorChecked: false,
          operatorNote: "", // Catatan operator satu kolom
          operatorResult: kontainerAman, // Status kontainer aman/tidak aman
          operatorPIB: "",
          operatorPayment: "",
          operatorCustoms: "",
          operatorSPPB: "",
          operatorDokumentasi: "", // Tambah aksi dokumentasi
        };
        const items = getItems();
        items.push(item);
        setItems(items);
        renderAllTables();

        // SweetAlert untuk simulasi truk & kontainer tiba
        Swal.fire({
          icon: "success",
          title: "Truk & Kontainer Tiba",
          html: `<b>No. Kontainer:</b> ${item.number}<br><b>No. Polisi:</b> ${item.truck}<br><b>Jalur:</b> ${customsStatus}<br><b>Klasifikasi:</b> ${klasifikasi}<br>Data sudah terbaca di Gate OCR.`,
          timer: 2500,
          showConfirmButton: false,
        });
      };

      // Simulasi OCR tidak valid (manual barcode)
      $("#btn-simulate-ocr-invalid").addEventListener("click", () => {
        const pajak = hitungPajakImpor({
          fob_usd: 4000,
          freight_usd: 400,
          insurance_usd: 40,
          tarif_bea_masuk: 0.05,
          kurs_pajak: 16000,
          biaya_clearance: 100,
          biaya_trucking: 80,
          biaya_storage: 50,
          punya_npwp: false,
        });
        const item = {
          id: "ID" + Math.random().toString(36).slice(2, 9),
          number: "TEMU 654321 1",
          truck: "F 4321 DEF",
          jalur: "-",
          posisi: "Gate",
          klasifikasi: "-",
          status: "ocr_invalid",
          pajak: pajak,
          log: [
            {
              time: new Date().toISOString(),
              message: "OCR gagal/tidak lengkap. Truk berhenti di Gate Utama.",
            },
          ],
          sentToOperator: false,
          operatorChecked: false,
          operatorNote: "",
          operatorResult: "",
          operatorPIB: "",
          operatorPayment: "",
          operatorCustoms: "",
          operatorSPPB: "",
        };
        const items = getItems();
        items.push(item);
        setItems(items);
        renderAllTables();
      });

      // Status proses digital & QR Code
      function getProcessStatus(item) {
        let customsBadge = "";
        if (item.jalur === "Jalur Hijau")
          customsBadge = '<span class="badge ok">Hijau</span>';
        else if (item.jalur === "Jalur Kuning")
          customsBadge = '<span class="badge warn">Kuning</span>';
        else if (item.jalur === "Jalur Merah")
          customsBadge = '<span class="badge err">Merah</span>';
        else customsBadge = "-";

        return `
    <div>PIB: <span class="badge ok">Submitted</span></div>
    <div>Payment: <span class="badge ok">Processed</span></div>
    <div>Customs: ${customsBadge}</div>
    <div>SPPB: <span class="badge ${
      item.status === "ocr_valid" ? "ok" : "warn"
    }">${item.status === "ocr_valid" ? "Issued" : "Pending"}</span></div>
    ${
      item.status === "ocr_valid" || item.status === "manual_valid"
        ? `<div id="qrcode-${item.id}"></div>
    <div class="muted" style="margin-top:6px;">Notifikasi ke armada: Gate Pass digital diterbitkan</div>`
        : ""
    }
  `;
      }

      // Barcode modal logic
      window.showBarcodeModal = function (id) {
        $("#barcode-modal").classList.remove("hide");
        $("#barcode-modal").dataset.id = id;
      };
      $("#btn-barcode-cancel").addEventListener("click", () => {
        $("#barcode-modal").classList.add("hide");
        $("#barcode-input").value = "";
      });
      $("#btn-barcode-validate").addEventListener("click", () => {
        const id = $("#barcode-modal").dataset.id;
        const code = $("#barcode-input").value.trim();
        if (!code) {
          alert("Masukkan kode barcode!");
          return;
        }
        const items = getItems();
        const item = items.find((it) => it.id === id);
        // Barcode valid jika cocok dengan salah satu DB_CONTAINERS
        const valid = DB_CONTAINERS.some(
          (db) => db.number === item.number && db.truck === item.truck
        );
        if (valid) {
          item.status = "manual_valid";
          item.log.push({
            time: new Date().toISOString(),
            message: "Barcode valid, palang Gate Utama terbuka.",
          });
        } else {
          item.log.push({
            time: new Date().toISOString(),
            message: "Barcode tidak valid, akses ditolak.",
          });
        }
        setItems(items);
        $("#barcode-modal").classList.add("hide");
        $("#barcode-input").value = "";
        renderAllTables();
      });

      // Kirim ke operator (hanya kuning, merah, ocr_invalid)
      window.sendToOperator = function (id) {
        const items = getItems();
        const item = items.find((it) => it.id === id);
        item.sentToOperator = true;
        setItems(items);
        renderOperatorTable();
        renderAllTables();
      };

      // Tabel per jalur
      function renderJalurTable(jalur, label, badgeClass) {
        const items = getItems().filter((item) => {
          if (jalur === "ocr_invalid") return item.status === "ocr_invalid";
          return item.jalur === label;
        });
        let html = `
    <h3>Jalur ${label || "OCR Tidak Valid"}</h3>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>No. Kontainer</th>
            <th>No. Polisi Truk</th>
            <th>Posisi</th>
            <th>Klasifikasi</th>
            <th>Status</th>
            <th>Aksi</th>
            <th>Log & Pajak & Proses</th>
            <th>Hasil Operator</th>
          </tr>
        </thead>
        <tbody>
  `;
        items.forEach((item, idx) => {
          let statusText = "";
          let aksiBtn = "";
          if (item.status === "ocr_valid") {
            statusText =
              '<span class="badge ok">Lolos OCR & SPPB Terbit</span>';
            aksiBtn = "-";
          } else if (item.status === "pending_sppb") {
            statusText = '<span class="badge warn">Menunggu SPPB</span>';
            aksiBtn = "-";
          } else if (item.status === "ocr_invalid") {
            statusText =
              '<span class="badge err">Gagal OCR (Scan Barcode)</span>';
            aksiBtn = `<button class="btn small ok" onclick="showBarcodeModal('${item.id}')">Scan Barcode</button>`;
            if (!item.sentToOperator)
              aksiBtn += `<button class="btn small warn" onclick="sendToOperator('${item.id}')">Kirim ke Operator</button>`;
          } else if (item.status === "manual_valid") {
            statusText =
              '<span class="badge ok">Barcode Valid (Gate 2 terbuka)</span>';
            aksiBtn = "-";
          }
          // Jalur kuning/merah bisa kirim ke operator jika belum dicek
          if (
            (item.jalur === "Jalur Kuning" || item.jalur === "Jalur Merah") &&
            !item.sentToOperator
          ) {
            aksiBtn += `<button class="btn small warn" onclick="sendToOperator('${item.id}')">Kirim ke Operator</button>`;
          }
          // Pajak info
          let pajakHtml = "";
          if (item.pajak) {
            pajakHtml = Object.entries(item.pajak)
              .map(
                ([k, v]) =>
                  `<div>${k}: <b>${v.toLocaleString(undefined, {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2,
                  })}</b></div>`
              )
              .join("");
          }
          const logHtml = item.log
            .map(
              (l) =>
                `<div>${new Date(l.time).toLocaleString()}<br>${
                  l.message
                }</div>`
            )
            .join("");
          const detailId = `detail-cell-${jalur}-${idx}`;
          html += `<tr>
      <td>${item.number}</td>
      <td>${item.truck}</td>
      <td>${item.posisi || "-"}</td>
      <td>${getKlasifikasiJalur(item.jalur, item.number)}</td>
      <td><span class="badge ${badgeClass}">${statusText}</span></td>
      <td>${aksiBtn}</td>
      <td>
        <div id="${detailId}" class="detail-cell">
          ${logHtml}${
            pajakHtml ? "<hr>" + pajakHtml : ""
          }<hr>${getProcessStatus(item)}
        </div>
        <button class="detail-toggle" onclick="toggleDetail('${detailId}')">Lihat Detail</button>
      </td>
      <td>${
        item.operatorResult
          ? `<span class="badge ${
              item.operatorResult === "Aman" ? "ok" : "err"
            }">${item.operatorResult}</span>`
          : "-"
      }</td>
    </tr>`;
        });
        html += `</tbody></table></div>`;
        return html;
      }

      function renderAllTables() {
        $("#jalur-hijau").innerHTML = renderJalurTable(
          "hijau",
          "Jalur Hijau",
          "ok"
        );
        $("#jalur-kuning").innerHTML = renderJalurTable(
          "kuning",
          "Jalur Kuning",
          "warn"
        );
        $("#jalur-merah").innerHTML = renderJalurTable(
          "merah",
          "Jalur Merah",
          "err"
        );
        $("#jalur-ocr").innerHTML = renderJalurTable("ocr_invalid", "", "info");
        // QR Code
        const items = getItems();
        items.forEach((item) => {
          if (
            (item.status === "ocr_valid" || item.status === "manual_valid") &&
            window.QRCode
          ) {
            setTimeout(() => {
              const el = document.getElementById("qrcode-" + item.id);
              if (el && !el.hasChildNodes()) {
                new QRCode(el, {
                  text: "GatePass-" + item.id,
                  width: 80,
                  height: 80,
                });
              }
            }, 100);
          }
        });
      }

      // Operator page
      function renderOperatorTable() {
        const items = getItems().filter((item) => item.sentToOperator);
        const tbody = $("#operator-table-body");
        tbody.innerHTML = "";
        items.forEach((item) => {
          // Tampilkan hanya aksi yang belum selesai
          let aksiList = [];
          if (!item.operatorPIB) aksiList.push("PIB");
          if (!item.operatorPayment) aksiList.push("Payment");
          if (!item.operatorCustoms) aksiList.push("Customs");
          if (!item.operatorSPPB) aksiList.push("SPPB");
          if (!item.operatorDokumentasi) aksiList.push("Dokumentasi");

          let aksiHtml = aksiList
            .map(
              (label) => `
      <div style="margin-bottom:4px;">
        <button class="btn small ok" onclick="operatorSetResult('${item.id}','operator${label}','Aman')">${label} Aman</button>
        <button class="btn small err" onclick="operatorSetResult('${item.id}','operator${label}','Tidak Aman')">${label} Tidak Aman</button>
      </div>
    `
            )
            .join("");

          tbody.innerHTML += `<tr>
      <td>${item.number}</td>
      <td>${item.truck}</td>
      <td>${item.jalur || "-"}</td>
      <td>${item.posisi || "-"}</td>
      <td>${getKlasifikasiJalur(item.jalur, item.number)}</td>
      <td>${aksiHtml || "-"}</td>
      <td>
        <textarea style="width:98%;min-height:40px;" placeholder="Catatan operator..." onblur="saveOperatorNote('${
          item.id
        }', this.value)">${item.operatorNote || ""}</textarea>
      </td>
      <td>${
        item.operatorResult
          ? `<span class="badge ${
              item.operatorResult === "Aman" ? "ok" : "err"
            }">${item.operatorResult}</span>`
          : "-"
      }</td>
    </tr>`;
        });
        // ...existing code...

        // Simpan catatan operator satu kolom
        window.saveOperatorNote = function (id, val) {
          const items = getItems();
          const item = items.find((it) => it.id === id);
          item.operatorNote = val;
          setItems(items);
        };
      }

      // Temp untuk catatan operator sebelum submit
      window.operatorNoteTemp = {};

      // Operator set hasil pengecekan per proses + catatan
      window.operatorSetResult = function (id, field, result) {
        const items = getItems();
        const item = items.find((it) => it.id === id);
        item[field] = result;
        // Jika field adalah operatorDokumentasi, log khusus
        if (field === "operatorDokumentasi") {
          item.log.push({
            time: new Date().toISOString(),
            message: `Operator: Dokumentasi ${result}`,
          });
        } else {
          item.log.push({
            time: new Date().toISOString(),
            message: `Operator: ${field.replace("operator", "")} ${result}`,
          });
        }
        // Jika field adalah operatorCustoms, update status kontainer
        if (field === "operatorCustoms") {
          item.operatorResult = result === "Aman" ? "Aman" : "Tidak Aman";
        }
        setItems(items);
        renderOperatorTable();
        renderAllTables();
      };

      // Accordion detail
      window.toggleDetail = function (id) {
        const el = document.getElementById(id);
        if (el.classList.contains("open")) {
          el.classList.remove("open");
        } else {
          el.classList.add("open");
        }
      };

      // Rumus pajak dari pajak.py
      function hitungPajakImpor({
        fob_usd,
        freight_usd,
        insurance_usd,
        tarif_bea_masuk,
        tarif_ppn = 0.11,
        tarif_pph_npwp = 0.025,
        kurs_pajak = 16000,
        punya_npwp = true,
        biaya_clearance = 0,
        biaya_trucking = 0,
        biaya_storage = 0,
      }) {
        const cif = fob_usd + freight_usd + insurance_usd;
        const bea_masuk = cif * tarif_bea_masuk;
        const dpp = cif + bea_masuk;
        const ppn = dpp * tarif_ppn;
        const tarif_pph = punya_npwp ? tarif_pph_npwp : 0.075;
        const pph_22 = dpp * tarif_pph;
        const total_pajak = bea_masuk + ppn + pph_22;
        const landed_cost_usd =
          cif + total_pajak + biaya_clearance + biaya_trucking + biaya_storage;
        const landed_cost_idr = landed_cost_usd * kurs_pajak;
        return {
          "CIF (USD)": cif,
          "Bea Masuk (USD)": bea_masuk,
          "DPP (USD)": dpp,
          "PPN (USD)": ppn,
          "PPh 22 (USD)": pph_22,
          "Total Pajak (USD)": total_pajak,
          "Total Landed Cost (USD)": landed_cost_usd,
          "Total Landed Cost (IDR)": landed_cost_idr,
        };
      }

      // Reset data admin
      document.getElementById("btn-reset-admin").onclick = function () {
        Swal.fire({
          title: "Reset Data?",
          text: "Semua data kontainer akan dihapus permanen!",
          icon: "warning",
          showCancelButton: true,
          confirmButtonText: "Ya, hapus!",
          cancelButtonText: "Batal",
        }).then((result) => {
          if (result.isConfirmed) {
            localStorage.removeItem(KEYS.items);
            renderAllTables();
            Swal.fire("Data direset!", "", "success");
          }
        });
      };
      // Reset data operator
      document.getElementById("btn-reset-operator").onclick = function () {
        Swal.fire({
          title: "Reset Data?",
          text: "Semua data kontainer akan dihapus permanen!",
          icon: "warning",
          showCancelButton: true,
          confirmButtonText: "Ya, hapus!",
          cancelButtonText: "Batal",
        }).then((result) => {
          if (result.isConfirmed) {
            localStorage.removeItem(KEYS.items);
            renderOperatorTable();
            Swal.fire("Data direset!", "", "success");
          }
        });
      };
    </script>
  </body>
</html>
